<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ¹é…ç»“æœ - æ ¡å›­å¤±ç‰©æ‹›é¢†</title>
    <link href="https://bootswatch.com/5/quartz/bootstrap.css" rel="stylesheet">
    <script src="/static/js/config.js"></script>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">è¿”å›é¦–é¡µ</a>
            <a href="personal-center.html" class="btn btn-info ms-auto">å‰å¾€ä¸ªäººä¸­å¿ƒ</a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼Œæ·»åŠ äº† id -->
    <div class="container mt-4" id="main-container">
        <div id="publish-success-alert" style="display: none;">
            <div class="text-center mb-4">
                <h2 class="text-success">ğŸ‰ å‘å¸ƒæˆåŠŸï¼</h2>
                <p class="lead">æˆ‘ä»¬ä¸ºæ‚¨æ‰¾åˆ°äº†ä»¥ä¸‹å¯èƒ½ç›¸å…³çš„ç‰©å“ä¿¡æ¯ï¼š</p>
            </div>
        </div>

        <!-- åŒºåŸŸ1ï¼šå±•ç¤ºä½ åˆšåˆšå‘å¸ƒçš„ç‰©å“ -->
        <div class="mb-5">
            <h4>æ‚¨å‘å¸ƒçš„ç‰©å“ï¼š</h4>
            <div id="my-published-item">
                <p class="text-center">æ­£åœ¨åŠ è½½æ‚¨å‘å¸ƒçš„ç‰©å“...</p>
            </div>
        </div>

        <hr>

        <!-- åŒºåŸŸ2ï¼šå±•ç¤ºåŒ¹é…åˆ°çš„ç‰©å“åˆ—è¡¨ -->
        <div id="match-section">
            <h4>ä¸ºæ‚¨åŒ¹é…åˆ°çš„ä¿¡æ¯ï¼š</h4>
            <div id="matched-item-list" class="row">
                <p id="match-loading-status" class="text-center">æ­£åœ¨æŸ¥æ‰¾åŒ¹é…ä¿¡æ¯...</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ JS åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const newItemId = urlParams.get('id');
            const source = urlParams.get('source');
            const itemType = urlParams.get('type');

            if (!newItemId) {
                alert('é”™è¯¯ï¼šæœªæ‰¾åˆ°ç‰©å“IDã€‚');
                window.location.href = 'index.html';
                return;
            }

            if (source === 'publish') {
                $('#publish-success-alert').show();
            }

            // ğŸ§© æ¨¡å—åŒ–ï¼šå‹å¥½æç¤ºæ¡†æ’å…¥å‡½æ•°
            function showFriendlyAlert(friendlyAlertHtml) {
                $('#no-match-result-alert').remove();
                $('#main-container').prepend(`
                    <div id="no-match-result-alert">
                        ${friendlyAlertHtml}
                        <div class="text-center mt-3">
                            <a href="index.html" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
                            <a href="personal-center.html" class="btn btn-secondary mx-2">æŸ¥çœ‹æˆ‘å‘å¸ƒçš„ç‰©å“</a>
                        </div>
                    </div>
                `);
            }

            // ğŸ§© åŠ è½½å•ä¸ªç‰©å“ä¿¡æ¯
            function loadSingleItem(itemId, containerId) {
                $.ajax({
                    url: `${API_BASE_URL}/api/items/${itemId}/`,
                    type: 'GET',
                    headers: { 'Authorization': 'Token ' + token },
                    success: function (item) {
                        const cardHtml = createItemCard(item, false);
                        $(containerId).html(cardHtml);
                    },
                    error: function () {
                        $(containerId).html('<p class="text-danger">åŠ è½½ç‰©å“è¯¦æƒ…å¤±è´¥ã€‚</p>');
                    }
                });
            }

            // ğŸ§© åŠ è½½åŒ¹é…ç»“æœ
            function loadMatches(itemId) {
                $.ajax({
                    url: `${API_BASE_URL}/api/items/${itemId}/matches/`,
                    type: 'GET',
                    headers: { 'Authorization': 'Token ' + token },
                    success: function (matches) {
                        $('#match-loading-status').hide();
                        const matchList = $('#matched-item-list');
                        matchList.empty();

                        if (!matches || matches.length === 0) {
                            $('#match-section').hide();

                            let friendlyAlertHtml = '';
                            if (source === 'publish' && itemType === 'LOST') {
                                friendlyAlertHtml = `
                                <div class="alert alert-info text-center" role="alert">
                                    <h4 class="alert-heading">æ‚¨çš„å¤±ç‰©ä¿¡æ¯å·²æˆåŠŸå‘å¸ƒï¼</h4>
                                    <p>æˆ‘ä»¬æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ‹¾ç‰©ä¿¡æ¯ã€‚</p>
                                    <p class="mb-0">å½“æœ‰æ–°çš„åŒ¹é…ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚</p>
                                </div>`;
                            } else if (source === 'publish' && itemType === 'FOUND') {
                                friendlyAlertHtml = `
                                <div class="alert alert-success text-center" role="alert">
                                    <h4 class="alert-heading">æ„Ÿè°¢æ‚¨çš„æ‹¾é‡‘ä¸æ˜§ï¼Œä¿¡æ¯å·²å‘å¸ƒï¼</h4>
                                    <p>ç›®å‰è¿˜æ²¡æœ‰äººå‘å¸ƒä¸¢å¤±æ­¤ç‰©å“çš„ä¿¡æ¯ã€‚</p>
                                    <p class="mb-0">å¤±ä¸»ç°åœ¨å¯ä»¥é€šè¿‡å¹³å°çœ‹åˆ°æ‚¨å‘å¸ƒçš„ä¿¡æ¯äº†ï¼Œè¯·è€å¿ƒç­‰å¾…è”ç³»ã€‚</p>
                                </div>`;
                            } else {
                                // ä¸ªäººä¸­å¿ƒä¸­æ‰‹åŠ¨æŸ¥çœ‹ï¼Œæ— åŒ¹é…
                                matchList.html('<p class="text-center text-muted col-12">æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°ä¸æ­¤ç‰©å“ç›¸å…³çš„åŒ¹é…ä¿¡æ¯ã€‚</p>');
                                $('#match-section').show();
                                $('#my-published-item').closest('div').hide();
                                return;
                            }

                            showFriendlyAlert(friendlyAlertHtml);
                            $('#my-published-item').closest('div').hide();
                        } else {
                            matches.forEach(item => {
                                matchList.append(createItemCard(item, false));
                            });
                        }
                    },
                    error: function () {
                        $('#match-loading-status').text('åŠ è½½åŒ¹é…ä¿¡æ¯å¤±è´¥ã€‚').addClass('text-danger');
                    }
                });
            }

            // ğŸ§© å¡ç‰‡æ¸²æŸ“å‡½æ•°
            function createItemCard(item, showAdminButtons) {
                const itemType = item.type || 'UNKNOWN';
                const cardClass = itemType.toUpperCase() === 'LOST' ? 'border-danger' : 'border-success';
                const titlePrefix = itemType.toUpperCase() === 'LOST' ? 'ã€å¤±ç‰©ã€‘' : 'ã€æ‹¾ç‰©ã€‘';
                const imageHtml = item.image_url ? `<img src="${item.image_url}" class="card-img-top" alt="${item.title}" style="max-height: 200px; object-fit: cover;">` : '';

                let buttonsHtml = '';
                if (showAdminButtons) {
                    buttonsHtml = `
                    <div class="card-footer bg-transparent">
                        <a href="item-detail.html?id=${item.id}" class="btn btn-outline-light btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                        <button class="btn btn-primary btn-sm edit-btn" data-id="${item.id}">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">åˆ é™¤</button>
                    </div>`;
                }

                return `
                <div class="col-md-4 mb-4">
                    <div class="card h-100 ${cardClass}">
                        ${imageHtml}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <span class="badge bg-secondary me-2">${item.item_class || 'å…¶ä»–'}</span>
                                ${titlePrefix} ${item.title}
                            </h5>
                            <p class="card-text"><strong>æè¿°ï¼š</strong>${item.description || 'æ— '}</p>
                            <p class="card-text"><small class="text-muted"><strong>åœ°ç‚¹ï¼š</strong>${item.location}</small></p>
                            ${item.time ? `<p class="card-text"><small class="text-muted"><strong>æ—¥æœŸï¼š</strong>${item.time}</small></p>` : ''}
                            <p class="card-text mt-auto"><strong>è”ç³»æ–¹å¼ï¼š</strong><span class="badge bg-info">${item.contact}</span></p>
                        </div>
                        ${showAdminButtons ? buttonsHtml : `
                        <div class="card-footer">
                            <small class="text-muted">å‘å¸ƒäº: ${new Date(item.created_at).toLocaleString()}</small>
                        </div>`}
                    </div>
                </div>`;
            }

            // ğŸ”„ åˆå§‹åŒ–ï¼šåŠ è½½ç‰©å“å’ŒåŒ¹é…
            loadSingleItem(newItemId, '#my-published-item');
            loadMatches(newItemId);
        });
    </script>
</body>

</html>